# BQYX Captcha OCR Service

è¿™æ˜¯ä¸€ä¸ªåŸºäº Pythonã€Flask å’Œ ddddocr çš„è½»é‡çº§å¾®æœåŠ¡ï¼Œä¸“é—¨ç”¨äºè¯†åˆ«ã€Šçˆ†æªè‹±é›„ã€‹æ¸¸æˆ (åŒ…æ‹¬å…¶ä»–4399æ¸¸æˆ) ç™»å½•æ—¶å¯èƒ½å‡ºç°çš„4399éªŒè¯ç ã€‚

è¯¥æœåŠ¡è¢«è®¾è®¡ä¸º Node.js ä¸»åº”ç”¨çš„è¾…åŠ©æœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ HTTP API ç«¯ç‚¹æ¥æ”¶éªŒè¯ç å›¾ç‰‡ï¼Œå¹¶è¿”å›è¯†åˆ«å‡ºçš„æ–‡æœ¬ç»“æœã€‚

![ddddocr](https://img.shields.io/badge/OCR%20Engine-ddddocr-blue)
![Flask](https://img.shields.io/badge/Framework-Flask-green)
![Python](https://img.shields.io/badge/Python-3.8+-blueviolet)

---

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **é«˜æ•ˆè¯†åˆ«**: ä½¿ç”¨ `ddddocr` åº“ï¼ŒåŠ è½½äº†é’ˆå¯¹ 4399 éªŒè¯ç çš„ç‰¹å®š ONNX æ¨¡å‹ï¼Œè¯†åˆ«å‡†ç¡®ç‡é«˜ã€‚
- **é«˜æ€§èƒ½**: Flask æœåŠ¡å¯åŠ¨æ—¶é¢„åŠ è½½ OCR æ¨¡å‹ï¼Œåç»­è¯†åˆ«è¯·æ±‚å“åº”é€Ÿåº¦å¿«ï¼Œé¿å…äº†é‡å¤åŠ è½½æ¨¡å‹çš„å¼€é”€ã€‚
- **æ ‡å‡† API æ¥å£**: æä¾›ä¸€ä¸ªç®€å•çš„ `/recognize` ç«¯ç‚¹ï¼Œé€šè¿‡ `POST` è¯·æ±‚æ¥æ”¶å›¾ç‰‡æ–‡ä»¶ï¼Œè¿”å› JSON æ ¼å¼çš„ç»“æœï¼Œæ˜“äºä»»ä½•ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚æœ¬é¡¹ç›®ä¸­çš„ Node.jsï¼‰è¿›è¡Œè°ƒç”¨ã€‚
- **å¥å£®æ€§**: åŒ…å«å¥åº·æ£€æŸ¥ (`/health`) ç«¯ç‚¹ï¼Œå¹¶å¯¹è¾“å…¥å’Œè¯†åˆ«è¿‡ç¨‹ä¸­çš„æ½œåœ¨å¼‚å¸¸è¿›è¡Œäº†å¤„ç†ã€‚
- **æ˜“äºéƒ¨ç½²**: ç»“æ„ç®€å•ï¼Œä¾èµ–æ¸…æ™°ï¼Œå¯ä»¥è½»æ¾åœ°é€šè¿‡ Docker æˆ–åœ¨ä»»ä½•æ”¯æŒ Python çš„äº‘å¹³å°ä¸Šè¿›è¡Œéƒ¨ç½²ã€‚

---

## ğŸ› ï¸ å®‰è£…ä¸ç¯å¢ƒè®¾ç½®

ä¸ºäº†ç¡®ä¿é¡¹ç›®ä¾èµ–çš„éš”ç¦»æ€§ï¼Œå¼ºçƒˆå»ºè®®åœ¨ Python è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œæ­¤æœåŠ¡ã€‚

### 1. å…‹éš†ä»“åº“

```bash
git clone zzl-Jiang/4399-captcha-ocr
```

### 2. å®‰è£…ä¾èµ–

æœ¬é¡¹ç›®çš„æ‰€æœ‰ Python ä¾èµ–éƒ½è®°å½•åœ¨ `requirements.txt` æ–‡ä»¶ä¸­ã€‚

```bash
# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
(venv) pip install -r requirements.txt
```

**`requirements.txt` æ–‡ä»¶å†…å®¹:**
```
flask
ddddocr
waitress
# æˆ–è€… gunicorn (ç”¨äº Linux ç”Ÿäº§ç¯å¢ƒ)
```

### 4. å‡†å¤‡æ¨¡å‹æ–‡ä»¶

è¯·ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å·²æ”¾ç½®åœ¨ `data/ocr_data/` ç›®å½•ä¸‹ï¼š

- `4399ocr.onnx` (ONNX æ¨¡å‹æ–‡ä»¶)
- `4399ocr.json` (æ¨¡å‹å¯¹åº”çš„å­—ç¬¦é›†æ–‡ä»¶)

é¡¹ç›®ç»“æ„åº”å¦‚ä¸‹æ‰€ç¤ºï¼š
```
.
â”œâ”€â”€ data/
â”‚   â””â”€â”€ ocr_data/
â”‚       â”œâ”€â”€ 4399ocr.json
â”‚       â””â”€â”€ 4399ocr.onnx
â”œâ”€â”€ ocr_server.py
â””â”€â”€ requirements.txt
```

---

## ğŸƒâ€â™‚ï¸ å¦‚ä½•è¿è¡Œ

### å¼€å‘ç¯å¢ƒ

åœ¨å¼€å‘å’Œæµ‹è¯•æ—¶ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¿è¡Œ `ocr_server.py`ã€‚

```bash
# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
(venv) python ocr_server.py
```

æœåŠ¡å¯åŠ¨åï¼Œæ‚¨å°†åœ¨ç»ˆç«¯çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼š
```
æ­£åœ¨åŠ è½½ OCR æ¨¡å‹...
OCR æ¨¡å‹åŠ è½½æˆåŠŸï¼
åœ¨ http://0.0.0.0:5001 ä¸Šå¯åŠ¨ OCR æœåŠ¡...
```
è¿™è¡¨ç¤ºæœåŠ¡æ­£åœ¨ç›‘å¬ `5001` ç«¯å£ï¼Œéšæ—¶å‡†å¤‡æ¥æ”¶è¯†åˆ«è¯·æ±‚ã€‚

### ç”Ÿäº§ç¯å¢ƒ (æ¨è)

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ `waitress` (è·¨å¹³å°) æˆ– `gunicorn` (Linux) æ¥è¿è¡Œ Flask åº”ç”¨ï¼Œå®ƒä»¬æ¯” Flask è‡ªå¸¦çš„å¼€å‘æœåŠ¡å™¨æ›´ç¨³å®šã€æ€§èƒ½æ›´å¥½ã€‚

**ä½¿ç”¨ Waitress:**
```bash
(venv) waitress-serve --host=0.0.0.0 --port=5001 ocr_server:app
```

**ä½¿ç”¨ Gunicorn (Linux/macOS):**
```bash
(venv) gunicorn --workers 4 --bind 0.0.0.0:5001 ocr_server:app
```

---

## ğŸ“¡ API ä½¿ç”¨è¯´æ˜

### ç«¯ç‚¹: `/recognize`

- **æ–¹æ³•**: `POST`
- **è¯·æ±‚ç±»å‹**: `multipart/form-data`
- **å‚æ•°**:
  - `image`: (æ–‡ä»¶) å¿…é¡»ã€‚åŒ…å«éªŒè¯ç å›¾ç‰‡äºŒè¿›åˆ¶å†…å®¹çš„æ–‡ä»¶ã€‚

**ç¤ºä¾‹è°ƒç”¨ (ä½¿ç”¨ curl):**
```bash
curl -X POST -F "image=@/path/to/your/captcha.png" http://localhost:5001/recognize
```

**æˆåŠŸå“åº” (Status `200 OK`):**
```json
{
  "success": true,
  "result": "qny2" 
}
```

**å¤±è´¥å“åº” (Status `400` or `500`):**
```json
{
  "success": false,
  "error": "No image file found in the request" 
}
```

### ç«¯ç‚¹: `/health`

- **æ–¹æ³•**: `GET`
- **ç”¨é€”**: ç”¨äºå¥åº·æ£€æŸ¥ï¼Œå¯ä»¥è¢«éƒ¨ç½²å¹³å°ï¼ˆå¦‚ Render, Dockerï¼‰æˆ–ç›‘æ§ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥ç¡®è®¤æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

**æˆåŠŸå“åº” (Status `200 OK`):**
```json
{
  "status": "ok"
}
```

**å¤±è´¥å“åº” (Status `503 Service Unavailable`):**
```json
{
  "status": "error",
  "message": "OCR model not loaded"
}
```

---

## ğŸ¤ ä¸ä¸»åº”ç”¨ (Node.js) çš„é›†æˆ

åœ¨ Node.js åº”ç”¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `axios` å’Œ `form-data` åº“æ¥è°ƒç”¨æ­¤ OCR æœåŠ¡ã€‚è¯·å‚è€ƒä¸»åº”ç”¨ `src/services/captchaService.js` æ–‡ä»¶ (ç”±äºå®‰å…¨æ€§è€ƒè™‘ï¼Œä»“åº“æš‚æ—¶æœªå…¬å¼€) ä¸­çš„å…·ä½“å®ç°ã€‚